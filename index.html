<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>EPUB Cleaner</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
        background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        color: #333;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    h2 {
        font-size: 2.2rem;
        margin-bottom: 0.5rem;
        color: #2c3e50;
        text-shadow: 1px 1px #fff;
    }
    p {
        margin-bottom: 1rem;
        font-size: 1rem;
        color: #555;
    }
    #localNotice {
        margin-top: 1rem;
        font-size: 0.9rem;
        color: #666;
        max-width: 400px;
    }
    #fileInput {
        padding: 0.8rem 1.2rem;
        font-size: 1rem;
        border-radius: 12px;
        border: 2px solid #2c3e50;
        background-color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    #fileInput:hover {
        background-color: #2c3e50;
        color: #fff;
        border-color: #2c3e50;
    }
    #status {
        margin-top: 1.5rem;
        font-style: italic;
        color: #34495e;
    }
    #note {
        margin-top: 2rem;
        font-size: 0.9rem;
        color: #777;
        max-width: 400px;
        line-height: 1.4;
    }
    #note a {
        color: #555;
        text-decoration: underline;
    }
</style>
</head>
<body>
<h2>EPUB Cleaner</h2>
<p>Upload any AO3 EPUB to remove extra blank paragraphs quickly and safely.</p>
<input type="file" id="fileInput" accept=".epub" />
<p id="localNotice">All processing happens locally in your browser; your book content is never uploaded to any server.</p>
<div id="status"></div>
<div id="note">
  Epub-Cleaner, created by SmoothFic<br/>
  <a href="https://github.com/SmoothFic/epub-cleaner" target="_blank">If you experience issues please let me know on GitHub</a>
</div>

<script>
function cleanContent(text) {
    return text.replace(/<p[^>]*>\s*(?:<br\s*\/?>)?\s*(?:&nbsp;)?\s*<\/p>/gi, "");
}

document.getElementById('fileInput').addEventListener('change', async function() {
    const file = this.files[0];
    const statusDiv = document.getElementById('status');
    if (!file) return;

    statusDiv.textContent = 'Processing...';

    try {
        const zip = await JSZip.loadAsync(file);

        const tasks = Object.keys(zip.files).map(async filename => {
            if (filename.endsWith('.xhtml') || filename.endsWith('.html')) {
                let text = await zip.files[filename].async('string');
                text = cleanContent(text);
                zip.file(filename, text);
            }
        });

        await Promise.all(tasks);

        const blob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);

        const originalName = file.name.replace(/\.epub$/i, '');
        a.download = originalName + '_clean.epub';

        a.click();
        statusDiv.textContent = 'Done! Your cleaned EPUB has been downloaded.';
    } catch (e) {
        console.error(e);
        statusDiv.textContent = 'Error: could not process the EPUB.';
    }
});
</script>
</body
